# ---- STAGE 1: Build ----
FROM node:22-slim AS builder
WORKDIR /app

COPY ../../package.json ../../package-lock.json* ./
COPY ../../packages ./packages
COPY . .

RUN npm install

RUN npm run build --workspace=backend

# Mantém apenas deps de produção do backend
RUN npm prune --production --workspace=backend

# ---- STAGE 2: Runtime ----
FROM node:22-slim
WORKDIR /app

# Copia node_modules e build do backend
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/apps/backend/dist ./dist
COPY --from=builder /app/apps/backend/package.json ./package.json
COPY --from=builder /app/apps/backend/drizzle.config.ts ./drizzle.config.ts
COPY --from=builder /app/apps/backend/drizzle ./drizzle

USER node
EXPOSE 3000

CMD ["sh", "-c", "npm run db:migrate --config=drizzle.config.ts && node dist/index.js"]